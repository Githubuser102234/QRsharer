<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced QR Code Generator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>

    <!-- QRCode.js library - Moved to head to ensure it's loaded globally before module scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode.js/1.0.0/qrcode.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Advanced QR Code Generator</h1>
        <p class="text-sm text-gray-600 mb-4 text-center">
            Your User ID: <span id="userIdDisplay" class="font-mono break-all">Loading...</span>
        </p>

        <!-- Message/Error Display Area -->
        <div id="messageBox" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
            <strong class="font-bold">Error:</strong>
            <span id="errorMessage" class="block sm:inline ml-2"></span>
        </div>
        <div id="successBox" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">
            <strong class="font-bold">Success:</strong>
            <span id="successMessage" class="block sm:inline ml-2"></span>
        </div>

        <!-- Input Section -->
        <div id="inputSection">
            <div class="mb-6">
                <label for="inputText" class="block text-gray-700 text-sm font-semibold mb-2">
                    Enter text to encode:
                </label>
                <textarea
                    id="inputText"
                    class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out resize-none h-32"
                    placeholder="Type your message or URL here..."
                ></textarea>
            </div>

            <button
                id="generateQrCodeBtn"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-200 ease-in-out transform hover:scale-105 active:scale-95 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
            >
                <!-- Loading spinner SVG -->
                <svg id="loadingSpinner" class="hidden animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="buttonText">Generate QR Code</span>
            </button>
        </div>

        <!-- Decoded Text Display (for incoming QR links) -->
        <div id="decodedTextDisplay" class="hidden mt-8 text-center bg-green-50 p-6 rounded-lg border border-green-200">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Decoded Content</h2>
            <p class="text-gray-700 text-lg break-words" id="decodedTextContent"></p>
            <p class="text-xs text-gray-500 mt-2">
                This content was retrieved from Firebase using the ID from the URL.
            </p>
            <button id="closeDecodedDisplay" class="mt-4 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-200">
                Close
            </button>
        </div>

        <!-- Generated QR Code Display -->
        <div id="qrCodeDisplay" class="hidden mt-8 text-center bg-gray-50 p-6 rounded-lg border border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Your QR Code</h2>
            <div class="flex justify-center mb-4">
                <canvas id="qrCodeCanvas" class="rounded-lg shadow-md"></canvas>
            </div>
            <p class="text-gray-700 text-sm break-all">
                Scan this QR code to redirect to: <a id="qrCodeLink" href="#" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline"></a>
            </p>
            <p class="text-xs text-gray-500 mt-2">
                The encoded text can be retrieved by an app that reads the '?id=' parameter from the URL.
            </p>
        </div>

        <!-- Recently Generated Codes List -->
        <div id="recentCodesSection" class="mt-8 pt-8 border-t border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">Recently Generated Codes</h2>
            <ul id="generatedCodesList" class="space-y-3">
                <!-- Recent codes will be injected here by JavaScript -->
                <li class="text-center text-gray-500">No codes generated yet.</li>
            </ul>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAVRkI7wPbzoNtWaREM0T0K49w_8odLOyw",
            authDomain: "qrsharer-9b4d7.firebaseapp.com",
            projectId: "qrsharer-9b4d7",
            storageBucket: "qrsharer-9b4d7.firebasestorage.app",
            messagingSenderId: "485915941252",
            appId: "1:485915941252:web:0433291bb9c6089b5765d1",
            measurementId: "G-YHWNQNWR5D"
        };

        let app;
        let db;
        let auth;
        let analytics; // Declare analytics variable
        let userId = null;
        let isAuthReady = false; // Flag to indicate if Firebase authentication is ready

        // Helper function to show messages
        function showMessage(type, message) {
            const messageBox = document.getElementById('messageBox');
            const errorMessageSpan = document.getElementById('errorMessage');
            const successBox = document.getElementById('successBox');
            const successMessageSpan = document.getElementById('successMessage');

            // Hide both message boxes initially
            messageBox.classList.add('hidden');
            successBox.classList.add('hidden');

            if (type === 'error') {
                errorMessageSpan.textContent = message;
                messageBox.classList.remove('hidden');
            } else if (type === 'success') {
                successMessageSpan.textContent = message;
                successBox.classList.remove('hidden');
            }
        }

        // Helper function to toggle loading state
        function setLoading(isLoading) {
            const generateBtn = document.getElementById('generateQrCodeBtn');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const buttonText = document.getElementById('buttonText');
            const inputTextarea = document.getElementById('inputText');

            if (isLoading) {
                generateBtn.disabled = true;
                loadingSpinner.classList.remove('hidden');
                buttonText.textContent = 'Generating...';
                inputTextarea.disabled = true;
            } else {
                generateBtn.disabled = !isAuthReady || !inputTextarea.value.trim();
                loadingSpinner.classList.add('hidden');
                buttonText.textContent = 'Generate QR Code';
                inputTextarea.disabled = false;
            }
        }

        // Function to parse URL parameters
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // Initialize Firebase when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', async () => {
            if (Object.keys(firebaseConfig).length === 0) {
                showMessage('error', 'Firebase configuration is missing. Cannot initialize Firebase.');
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                analytics = getAnalytics(app); // Initialize analytics
                db = getFirestore(app);
                auth = getAuth(app);

                // Set up authentication state listener
                onAuthStateChanged(auth, async (user) => {
                    if (!user) {
                        try {
                            // On GitHub Pages, __initial_auth_token won't be available, so sign in anonymously
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error('Error signing in:', error);
                            showMessage('error', `Authentication error: ${error.message}`);
                        }
                    }
                    userId = auth.currentUser?.uid || crypto.randomUUID();
                    document.getElementById('userIdDisplay').textContent = userId;
                    isAuthReady = true; // Mark authentication as ready
                    document.getElementById('generateQrCodeBtn').disabled = false; // Enable button once auth is ready

                    // Once authenticated, check for URL ID and set up real-time listener
                    fetchQrCodes();
                    checkUrlForId();
                });

            } catch (error) {
                console.error('Error initializing Firebase:', error);
                showMessage('error', `Firebase initialization error: ${error.message}`);
            }
        });

        // Function to construct the base URL for the QR codes
        function getBaseUrl() {
            // Combines origin (e.g., https://githubuser102234.github.io)
            // with pathname (e.g., /QRsharer/)
            return window.location.origin + window.location.pathname;
        }

        // Function to fetch and display recent QR codes
        function fetchQrCodes() {
            if (!db || !isAuthReady) return;

            // Use projectId from firebaseConfig as appId
            const appId = firebaseConfig.projectId;
            const qrCodesCollectionRef = collection(db, `artifacts/${appId}/public/data/qr_codes`);

            onSnapshot(qrCodesCollectionRef, (snapshot) => {
                const generatedCodesList = document.getElementById('generatedCodesList');
                generatedCodesList.innerHTML = ''; // Clear existing list

                if (snapshot.empty) {
                    generatedCodesList.innerHTML = '<li class="text-center text-gray-500">No codes generated yet.</li>';
                    return;
                }

                snapshot.docs.slice(0, 5).forEach(doc => { // Show up to the last 5 generated codes
                    const code = { id: doc.id, ...doc.data() };
                    const fullUrl = `${getBaseUrl()}?id=${code.id}`; // Use getBaseUrl() here
                    const listItem = document.createElement('li');
                    listItem.className = 'bg-blue-50 p-4 rounded-lg shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center';
                    listItem.innerHTML = `
                        <div class="flex-1 min-w-0 mr-4">
                            <p class="text-sm font-medium text-gray-900 break-words">
                                <span class="font-bold">Text:</span> ${code.text}
                            </p>
                            <p class="text-xs text-gray-600 mt-1 break-all">
                                <span class="font-bold">Link:</span> <a href="${fullUrl}" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline">${fullUrl}</a>
                            </p>
                        </div>
                        <div class="mt-2 sm:mt-0 flex-shrink-0">
                            <button data-id="${code.id}"
                                class="show-qr-btn inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-500 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.5h16.5m-16.5 2.25h16.5m-16.5 2.25h16.5m-16.5 2.25h16.5m-16.5 2.25h16.5m-16.5 2.25h16.5M3.75 21V6.75m0 0a3 3 0 013-3h12a3 3 0 013 3v14.25m-3.75 0V11.25m0 9.75a3 3 0 01-3-3V11.25m0 9.75h-3.75a3 3 0 01-3-3V11.25m3-6h.007v.008H16.5V5.25z" />
                                </svg>
                                Show QR
                            </button>
                        </div>
                    `;
                    generatedCodesList.appendChild(listItem);
                });

                // Add event listeners to newly created buttons
                document.querySelectorAll('.show-qr-btn').forEach(button => {
                    button.onclick = () => {
                        const qrId = button.dataset.id;
                        const fullUrl = `${getBaseUrl()}?id=${qrId}`; // Use getBaseUrl() here
                        displayQrCode(fullUrl);
                    };
                });

            }, (error) => {
                console.error('Error fetching QR codes:', error);
                showMessage('error', `Error fetching QR codes: ${error.message}`);
            });
        }

        // Function to check for 'id' parameter in URL
        async function checkUrlForId() {
            const id = getUrlParameter('id');
            if (id && db && isAuthReady) {
                // Hide input section and show decoded display
                document.getElementById('inputSection').classList.add('hidden');
                document.getElementById('qrCodeDisplay').classList.add('hidden');
                document.getElementById('decodedTextDisplay').classList.remove('hidden');
                document.getElementById('recentCodesSection').classList.add('hidden');

                try {
                    const appId = firebaseConfig.projectId; // Use projectId from firebaseConfig as appId
                    const docRef = doc(db, `artifacts/${appId}/public/data/qr_codes`, id);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        document.getElementById('decodedTextContent').textContent = docSnap.data().text;
                        showMessage('success', `Content loaded for ID: ${id}`);
                    } else {
                        document.getElementById('decodedTextContent').textContent = 'No content found for this ID.';
                        showMessage('error', `No content found for ID: ${id}`);
                    }
                } catch (error) {
                    console.error('Error fetching document by ID:', error);
                    showMessage('error', `Error fetching content: ${error.message}`);
                    document.getElementById('decodedTextContent').textContent = 'Failed to load content.';
                }
            } else {
                 // Ensure input section and recent codes are visible if no ID is in URL
                document.getElementById('inputSection').classList.remove('hidden');
                document.getElementById('recentCodesSection').classList.remove('hidden');
                document.getElementById('decodedTextDisplay').classList.add('hidden');
            }
        }

        // Function to display the QR code on the canvas
        function displayQrCode(url) {
            const canvas = document.getElementById('qrCodeCanvas');
            const qrCodeLink = document.getElementById('qrCodeLink');
            if (url) {
                if (typeof window.QRCode !== 'undefined') { // Explicitly check if the global QRCode object is available
                    showMessage('success', 'QR Code generated successfully!');
                    window.QRCode.toCanvas(canvas, url, { width: 256 }, function (error) {
                        if (error) {
                            console.error('Error in QRCode.toCanvas:', error);
                            showMessage('error', 'Error rendering QR code on canvas.');
                        }
                    });
                    qrCodeLink.href = url;
                    qrCodeLink.textContent = url;
                    document.getElementById('qrCodeDisplay').classList.remove('hidden');
                } else {
                    console.error("QR Code library (window.QRCode) is not defined. Ensure qrcode.min.js is loaded correctly.");
                    showMessage('error', 'QR code generation library failed to load. Please check console for details.');
                    document.getElementById('qrCodeDisplay').classList.add('hidden');
                }
            } else {
                document.getElementById('qrCodeDisplay').classList.add('hidden');
            }
        }


        // Event listener for Generate QR Code button
        document.getElementById('generateQrCodeBtn').addEventListener('click', async () => {
            const inputText = document.getElementById('inputText').value.trim();
            if (!inputText) {
                showMessage('error', 'Please enter text to generate a QR code.');
                return;
            }
            if (!db || !userId || !isAuthReady) {
                showMessage('error', 'Firebase not fully initialized or user not authenticated. Please wait.');
                return;
            }

            setLoading(true);
            showMessage(''); // Clear any previous messages

            try {
                const appId = firebaseConfig.projectId; // Use projectId from firebaseConfig as appId
                const qrCodesCollectionRef = collection(db, `artifacts/${appId}/public/data/qr_codes`);
                const docRef = await addDoc(qrCodesCollectionRef, {
                    text: inputText,
                    createdAt: new Date(),
                    createdBy: userId,
                });

                const fullUrl = `${getBaseUrl()}?id=${docRef.id}`; // Use getBaseUrl() here
                displayQrCode(fullUrl);
                document.getElementById('inputText').value = ''; // Clear input after generation

            } catch (error) {
                console.error('Error generating QR code:', error);
                showMessage('error', `Error generating QR code: ${error.message}`);
            } finally {
                setLoading(false);
            }
        });

        // Event listener for input text changes to enable/disable button
        document.getElementById('inputText').addEventListener('input', (e) => {
            const generateBtn = document.getElementById('generateQrCodeBtn');
            generateBtn.disabled = !isAuthReady || !e.target.value.trim();
        });

        // Event listener for closing decoded display
        document.getElementById('closeDecodedDisplay').addEventListener('click', () => {
            document.getElementById('decodedTextDisplay').classList.add('hidden');
            document.getElementById('inputSection').classList.remove('hidden');
            document.getElementById('recentCodesSection').classList.remove('hidden');
            showMessage(''); // Clear messages
            // Clear the URL parameter from the current URL without changing the path
            if (window.history.pushState) {
                const newurl = window.location.origin + window.location.pathname; // Keep origin and path
                window.history.pushState({ path: newurl }, '', newurl);
            } else {
                window.location.href = window.location.origin + window.location.pathname; // Fallback for older browsers
            }
        });
    </script>
</body>
</html>